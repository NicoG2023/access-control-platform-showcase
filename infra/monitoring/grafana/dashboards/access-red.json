{
    "uid": "haedcom-red",
    "title": "Access Core - RED (HTTP)",
    "timezone": "browser",
    "schemaVersion": 39,
    "version": 2,
    "refresh": "10s",
    "tags": [
        "haedcom",
        "red",
        "http",
        "quarkus"
    ],
    "time": {
        "from": "now-15m",
        "to": "now"
    },
    "panels": [
        {
            "type": "timeseries",
            "title": "RPS (total)",
            "description": "Requests por segundo (RPS) del servicio, agregadas para todos los endpoints HTTP. Excluye /q/* (metrics, health, openapi, swagger) para evitar contaminar el tráfico real. Úsalo para ver carga, picos y tendencias.",
            "gridPos": {
                "x": 0,
                "y": 0,
                "w": 12,
                "h": 8
            },
            "targets": [
                {
                    "refId": "A",
                    "expr": "sum(rate(http_server_requests_seconds_count{uri!~\"/q/metrics|/q/health|/q/openapi|/q/swagger-ui.*\"}[1m]))"
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "unit": "reqps"
                },
                "overrides": []
            }
        },
        {
            "type": "timeseries",
            "title": "5xx error rate (%)",
            "description": "Porcentaje de respuestas 5xx sobre el total de requests (en ventana de 5m). Indicador de fallas del servidor. Si sube, revisa logs, saturación de recursos (USE), pool DB (Agroal) y dependencias (Kafka/DB/servicios externos).",
            "gridPos": {
                "x": 12,
                "y": 0,
                "w": 12,
                "h": 8
            },
            "targets": [
                {
                    "refId": "A",
                    "expr": "100 * (sum(rate(http_server_requests_seconds_count{status=~\"5..\",uri!~\"/q/metrics|/q/health|/q/openapi|/q/swagger-ui.*\"}[5m])) / sum(rate(http_server_requests_seconds_count{uri!~\"/q/metrics|/q/health|/q/openapi|/q/swagger-ui.*\"}[5m])))"
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "unit": "percent",
                    "decimals": 2
                },
                "overrides": []
            }
        },
        {
            "type": "timeseries",
            "title": "Latency p50/p95/p99 (ms)",
            "description": "Latencia agregada del servicio (ms) usando histogramas (ventana 5m). p50 refleja el “caso típico”; p95/p99 muestran cola (slow requests). Si p95/p99 suben con RPS alto, sospecha saturación (threads/DB).",
            "gridPos": {
                "x": 0,
                "y": 8,
                "w": 24,
                "h": 9
            },
            "targets": [
                {
                    "refId": "A",
                    "expr": "1000 * histogram_quantile(0.50, sum(rate(http_server_requests_seconds_bucket{uri!~\"/q/metrics|/q/health|/q/openapi|/q/swagger-ui.*\"}[5m])) by (le))",
                    "legendFormat": "p50 (mediana)"
                },
                {
                    "refId": "B",
                    "expr": "1000 * histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{uri!~\"/q/metrics|/q/health|/q/openapi|/q/swagger-ui.*\"}[5m])) by (le))",
                    "legendFormat": "p95 (cola)"
                },
                {
                    "refId": "C",
                    "expr": "1000 * histogram_quantile(0.99, sum(rate(http_server_requests_seconds_bucket{uri!~\"/q/metrics|/q/health|/q/openapi|/q/swagger-ui.*\"}[5m])) by (le))",
                    "legendFormat": "p99 (cola extrema)"
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "unit": "ms",
                    "decimals": 1
                },
                "overrides": []
            }
        },
        {
            "type": "table",
            "title": "Top endpoints by p95 (ms)",
            "description": "Top 10 combinaciones (method + uri) con mayor latencia p95 (ms) en los últimos 5m. Útil para encontrar endpoints ‘lentos’ (cola). Ojo: con poco tráfico puede ser ruidoso; valida con RPS del endpoint y logs.",
            "gridPos": {
                "x": 0,
                "y": 17,
                "w": 12,
                "h": 9
            },
            "targets": [
                {
                    "refId": "A",
                    "expr": "topk(10, 1000 * histogram_quantile(0.95, sum by (le, method, uri) (rate(http_server_requests_seconds_bucket{uri!~\"/q/metrics|/q/health|/q/openapi|/q/swagger-ui.*\"}[5m]))))",
                    "format": "table"
                }
            ],
            "transformations": [
                {
                    "id": "organize",
                    "options": {
                        "excludeByName": {
                            "Time": true
                        },
                        "renameByName": {
                            "Value": "p95 (ms)"
                        }
                    }
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "unit": "ms",
                    "decimals": 1
                },
                "overrides": []
            }
        },
        {
            "type": "table",
            "title": "Top endpoints by RPS",
            "description": "Top 10 combinaciones (method + uri) por volumen (requests/seg) en los últimos 1m. Útil para detectar endpoints más usados, picos de carga y patrones de tráfico. Complementa con latencia p95 para priorizar optimización.",
            "gridPos": {
                "x": 12,
                "y": 17,
                "w": 12,
                "h": 9
            },
            "targets": [
                {
                    "refId": "A",
                    "expr": "topk(10, sum by (method, uri) (rate(http_server_requests_seconds_count{uri!~\"/q/metrics|/q/health|/q/openapi|/q/swagger-ui.*\"}[1m])))",
                    "format": "table"
                }
            ],
            "transformations": [
                {
                    "id": "organize",
                    "options": {
                        "excludeByName": {
                            "Time": true
                        },
                        "renameByName": {
                            "Value": "RPS"
                        }
                    }
                }
            ],
            "fieldConfig": {
                "defaults": {
                    "unit": "reqps",
                    "decimals": 3
                },
                "overrides": []
            }
        }
    ],
    "templating": {
        "list": []
    }
}